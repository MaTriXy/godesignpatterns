<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-site-verification" content="VqGny1x9EAeoXjY8v2hWFZGBUZFNQnavIOXVkY50mdk" />
    <meta name="msvalidate.01" content="AFECEF07C08280E3BFA946DDCE26B76C" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@alexjlockwood" />
    <meta name="twitter:creator" content="@alexjlockwood" />
    <meta name="twitter:domain" content="" />
    
    <!-- Don't include normal description meta tag for now. Only include twitter:description since it is explicitly required. -->
    <meta name="twitter:description" content="Android Design Patterns is a website for developers who wish to better understand the Android application framework. The tutorials here emphasize proper code design and project maintainability." />
    
    <meta property="og:locale" content="en_US" />
    <meta property="og:title" content="Google Play Services: Setup &amp; Verification" />
    
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2013-01-08T00:00:00-05:00" />
    <meta property="article:modified_time" content="2013-01-08T00:00:00-05:00" />
    
    <meta property="og:url" content="/2013/01/google-play-services-setup.html" />
    <meta property="og:site_name" content="Android Design Patterns" />
    
    <meta property="og:image" content="/assets/images/favicon256.png" />
    <title>Google Play Services: Setup &amp; Verification | Android Design Patterns</title>
    <link rel="canonical" href="/2013/01/google-play-services-setup.html" />
    <link rel="icon" href="/assets/images/favicon128.png" type="image/x-icon">
    <link href="/feed.atom" rel="alternate" title="Android Design Patterns - Feed" type="application/atom+xml" />
    <link rel="stylesheet" type="text/css" href="/css/all.css" />

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
  </head>

  <body>
    <div id="header">
      <div class="container">
        <h3 id="blog-header"><a href="/">Android Design Patterns</a></h3>
        <nav class="pull-right">
          <a href="/archives/">Archives</a>
          <a href="/about/">About</a>
        </nav>
      </div>
    </div>

    <div id="social" class="container">
      <a href="https://plus.google.com/100751609891157863386?rel=author" class="googleplus"><i class="icon-gplus"></i></a>
      <a href="https://twitter.com/alexjlockwood" class="twitter"><i class="icon-twitter"></i></a>
      <a href="https://github.com/alexjlockwood" class="github"><i class="icon-github-circled"></i></a>
      <a href="/feed.atom" class="rss"><i class="icon-rss"></i></a>
    </div>

    <div class="main container">
      <div id="content">
	<div class="blog-index">
          <div itemscope itemtype="http://schema.org/BlogPosting" class="post">
  <header><h1 itemprop="name">Google Play Services: Setup &amp; Verification</h1></header>

  <div class="side">
    <div class="date-posted" >
      Posted <span itemprop="datePublished" content="2013-01-08T00:00:00-05:00" class="date">Jan 8, 2013</span>
      <div class="author">by <a href="https://google.com/+AlexLockwood"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Alex Lockwood</span></span></a></div>
    </div>

    <div class="share-buttons">
      <div class="g-plusone" data-size="medium"></div>
      <div class="tweet"><a href="https://twitter.com/share" class="twitter-share-button" data-via="alexjlockwood" data-lang="en">Tweet</a></div>
      <div class="fb-like" data-href="/2013/01/google-play-services-setup.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
    </div>
  </div>

  <div class="body">
    <div itemprop="articleBody">
      <p>One of the trickiest aspects of writing a robust web-based Android application
is authentication, simply due to its asynchronous nature and the many edge cases
that one must cover. Thankfully, the recently released Google Play Services API
greatly simplifies the authentication process, providing developers with a
consistent and safe way to grant and receive OAuth2 access tokens to Google
services. Even so, there are still several cases that must be covered in order
to provide the best possible user experience. A professionally built Android
application should be able to react to even the most unlikely events, for example,
if a previously logged in user uninstalls Google Play Services, or navigates to
the system settings and clears the application’s data when the foreground Activity
is in a paused state. This post focuses on how to make use of the Google Play
Services library while still accounting for edge cases such as these.</p>

<!--more-->

<h3>Verifying Google Play Services</h3>

<p>In this post, we will implement a very basic (but robust) Android application
that authenticates a user with Google services. Our implementation will consist
of a single Activity:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">main</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>As you probably already know, before we attempt authentication using Google
Play Services, we must first verify that the service is up-to-date and
installed on the device. This seems easy enough, but where should
these checks be performed? As with most edge-case checks, it makes the most
sense to verify that our device is properly configured in the Activity’s
<code>onResume()</code> method. Verifying in <code>onResume()</code> is
important because it has the application perform a check each time the
Activity is brought into the foreground, thus guaranteeing that our application
will never incorrectly assume that Google Play Services is properly configured:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">checkPlayServices</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// Then we&#39;re good to go!</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Now let’s implement <code>checkPlayServices()</code>, which will return true if and only
if Google Play Services is correctly installed and configured on the device:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkPlayServices</span><span class="o">()</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">GooglePlayServicesUtil</span><span class="o">.</span><span class="na">isGooglePlayServicesAvailable</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">ConnectionResult</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">GooglePlayServicesUtil</span><span class="o">.</span><span class="na">isUserRecoverableError</span><span class="o">(</span><span class="n">status</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">showErrorDialog</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;This device is not supported.&quot;</span><span class="o">,</span> 
          <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
      <span class="n">finish</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span> 

<span class="kt">void</span> <span class="nf">showErrorDialog</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">GooglePlayServicesUtil</span><span class="o">.</span><span class="na">getErrorDialog</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> 
      <span class="n">REQUEST_CODE_RECOVER_PLAY_SERVICES</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>
<p>And we implement <code>onActivityResult</code> as follows:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">REQUEST_CODE_RECOVER_PLAY_SERVICES</span> <span class="o">=</span> <span class="mi">1001</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">switch</span> <span class="o">(</span><span class="n">requestCode</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nl">REQUEST_CODE_RECOVER_PLAY_SERVICES:</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">resultCode</span> <span class="o">==</span> <span class="n">RESULT_CANCELED</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;Google Play Services must be installed.&quot;</span><span class="o">,</span>
            <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
        <span class="n">finish</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>If Google Play Services are available, the method will return true. If
Google Play Services is not available and error is deemed &quot;unrecoverable,&quot;
a Toast will indicate to the user that the device is not supported. Otherwise,
an error dialog will be shown and a result will eventually propagate back to
<code>onActivityResult</code>. Note that <code>onActivityResult</code> is called <em>before</em> <code>onResume</code>,
so when a result is returned, we will perform one final check just to be sure
that everything has been setup correctly.</p>

<h3>Checking the Currently Logged In User</h3>

<p>What we have so far is enough to ensure that our users will be able to use our
application if and only if Google Play Services is installed and up-to-date.
Now let’s assume that our application also stores the name of the currently
logged in user in its <code>SharedPreferences</code>. How should our application respond
in the case that the current user is unexpectedly logged out (i.e. the user has
clicked &quot;Clear data&quot; in the app’s system settings)? It turns out that we can do
something very similar. (Note that the code below makes use of a simple utility
file named <a href="https://gist.github.com/4477849"><code>AccountUtils.java</code></a>,
which provides some helper methods for reading/writing account information to the
app’s <code>SharedPreferences</code>).</p>

<p>First, define a method that will verify the existence of a single authenticated
user in the application’s shared preferences and update the <code>onResume()</code> method
accordingly:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">checkPlayServices</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">checkUserAccount</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// Then we&#39;re good to go!</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkPlayServices</span><span class="o">()</span> <span class="o">{</span>
  <span class="cm">/* ... */</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkUserAccount</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">String</span> <span class="n">accountName</span> <span class="o">=</span> <span class="n">AccountUtils</span><span class="o">.</span><span class="na">getAccountName</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">accountName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Then the user was not found in the SharedPreferences. Either the</span>
    <span class="c1">// application deliberately removed the account, or the application&#39;s</span>
    <span class="c1">// data has been forcefully erased.</span>
    <span class="n">showAccountPicker</span><span class="o">();</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">AccountUtils</span><span class="o">.</span><span class="na">getGoogleAccountByName</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">accountName</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Then the account has since been removed.</span>
    <span class="n">AccountUtils</span><span class="o">.</span><span class="na">removeAccount</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">showAccountPicker</span><span class="o">();</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">showAccountPicker</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">Intent</span> <span class="n">pickAccountIntent</span> <span class="o">=</span> <span class="n">AccountPicker</span><span class="o">.</span><span class="na">newChooseAccountIntent</span><span class="o">(</span>
      <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="n">GoogleAuthUtil</span><span class="o">.</span><span class="na">GOOGLE_ACCOUNT_TYPE</span> <span class="o">},</span> 
      <span class="kc">true</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
  <span class="n">startActivityForResult</span><span class="o">(</span><span class="n">pickAccountIntent</span><span class="o">,</span> <span class="n">REQUEST_CODE_PICK_ACCOUNT</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>Note that in the case that a user is not already signed in, an <code>AccountPicker</code>
dialog will be launched, requesting that the user selects a Google account with
which the application will use to authenticate requests. The result will
eventually be returned back to the Activity, so we must update the <code>onActivityResult</code>
method accordingly:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">REQUEST_CODE_RECOVER_PLAY_SERVICES</span> <span class="o">=</span> <span class="mi">1001</span><span class="o">;</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">REQUEST_CODE_PICK_ACCOUNT</span> <span class="o">=</span> <span class="mi">1002</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">switch</span> <span class="o">(</span><span class="n">requestCode</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nl">REQUEST_CODE_RECOVER_PLAY_SERVICES:</span>
      <span class="cm">/* ... */</span>
    <span class="k">case</span> <span class="nl">REQUEST_CODE_PICK_ACCOUNT:</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">resultCode</span> <span class="o">==</span> <span class="n">RESULT_OK</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">accountName</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span>
            <span class="n">AccountManager</span><span class="o">.</span><span class="na">KEY_ACCOUNT_NAME</span><span class="o">);</span>
        <span class="n">AccountUtils</span><span class="o">.</span><span class="na">setAccountName</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">accountName</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">resultCode</span> <span class="o">==</span> <span class="n">RESULT_CANCELED</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">&quot;This application requires a Google account.&quot;</span><span class="o">,</span> 
            <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
        <span class="n">finish</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">return</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
 <span class="o">}</span>
</code></pre></div>
<p>As was the case before, <code>onResume</code> will be called after <code>onActivityResult</code>, ensuring
that Google Play Services is still installed and up-to-date, and that a Google account
has indeed been selected and saved to the disk.</p>

<h3>Conclusion</h3>

<p>However unlikely they might be, covering edge cases in your Android applications is
very important. If a user deliberately tries to break your application (by, for
example, clearing the application’s data in the system settings), the app should
immediately recognize the event and act appropriately. The same concept outlined
in this post applies to many areas of Android development, not just those apps
which make use of Google Play Services.</p>

<p>The full source code for this post is provided here 
<a href="https://gist.github.com/4477849"><code>AccountUtils.java</code></a> and
<a href="https://gist.github.com/4477939"><code>AuthActivity.java</code></a>. As always, leave
a comment if you have any questions and don’t forget to +1 this post!</p>

    </div>
    
    <div class="post-pagination">
      
      <div class="prev"><a rel="prev" href="/2012/10/sqlite-contentprovider-thread-safety.html">Older &#187;</a></div>
      
      
      <div class="next"><a rel="next" href="/2013/01/gcm-appengine-golang-android-backends.html">&#171; Newer</a></div>
      
    </div>

    <div id="responsive-post-bottom-ad">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-3588752900040136"
           data-ad-slot="6089694851"
           data-ad-format="auto"></ins>
      <script>
	(adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
    
    <div class="post-comments">
      <div id="disqus_thread"></div>
      <script src="/scripts/disqus-lazy-load.js"></script>
    </div>
    
  </div>

  
</div>

	</div>
      </div>

      <div id="info" class="cf">
	<div class="right">
          <div class="box">
            <h3>+1 this blog!</h3>
            <p>Android Design Patterns is a website for developers who wish to better understand the Android application framework. The tutorials here emphasize proper code design and project maintainability.</p>
            <div style="text-align:center">
              <div class="g-plusone" data-href=""></div>
	      <div class="tweet"><a href="https://twitter.com/share" class="twitter-share-button" data-via="alexjlockwood" data-lang="en">Tweet</a></div>
	      <div class="fb-like" data-href="/2013/01/google-play-services-setup.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
            </div>
          </div>
          <div class="box">
            <h3>Find a typo?</h3>
            <p>Submit a pull request! The code powering this site is open-source and available on <a href="https://github.com/alexjlockwood/alexjlockwood.github.io">GitHub</a>. Corrections are appreciated and encouraged! Click <a href="https://github.com/alexjlockwood/alexjlockwood.github.io/blob/master/README.md#find-a-typo">here</a> for instructions.</p>
          </div>
	</div>
	<div class="box gbadge">
          <div class="g-person" data-href="//plus.google.com/+AlexLockwood" data-rel="author"></div>
	</div>
      </div>
    </div>

    <div id="responsive-home-page-bottom-ad" class="container">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-3588752900040136"
           data-ad-slot="3555030858"
           data-ad-format="auto"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>

    <div id="copyright" class="container">
      <p>&copy; 2012-2014 Android Design Patterns</p>
    </div>

    <!-- +1 button javascript -->
    <script type="text/javascript">
      (function(){var a=document.createElement("script");
      a.type="text/javascript";a.async=true;a.src="https://apis.google.com/js/platform.js";
      var b=document.getElementsByTagName("script")[0];
      b.parentNode.insertBefore(a,b)})();
    </script>

    <!-- Tweet button javascript -->
    <script>!function(e,a,f){var c,b=e.getElementsByTagName(a)[0];if(!e.getElementById(f)){c=e.createElement(a);c.id=f;c.src="https://platform.twitter.com/widgets.js";b.parentNode.insertBefore(c,b)}}(document,"script","twitter-wjs");</script>

    <!-- Like button javascript -->
    <div id="fb-root"></div><script>(function(e,a,f){var c,b=e.getElementsByTagName(a)[0];if(e.getElementById(f)){return}c=e.createElement(a);c.id=f;c.src="//connect.facebook.net/en_US/all.js#xfbml=1";b.parentNode.insertBefore(c,b)}(document,"script","facebook-jssdk"));</script>

  </body>
</html>
