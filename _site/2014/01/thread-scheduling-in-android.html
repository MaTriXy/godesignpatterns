<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-site-verification" content="VqGny1x9EAeoXjY8v2hWFZGBUZFNQnavIOXVkY50mdk" />
    <meta name="msvalidate.01" content="AFECEF07C08280E3BFA946DDCE26B76C" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@alexjlockwood" />
    <meta name="twitter:creator" content="@alexjlockwood" />
    <meta name="twitter:domain" content="" />
    
    <!-- Don't include normal description meta tag for now. Only include twitter:description since it is explicitly required. -->
    <meta name="twitter:description" content="Android Design Patterns is a website for developers who wish to better understand the Android application framework. The tutorials here emphasize proper code design and project maintainability." />
    
    <meta property="og:locale" content="en_US" />
    <meta property="og:title" content="Thread Scheduling in Android" />
    
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2014-01-13T00:00:00-05:00" />
    <meta property="article:modified_time" content="2014-01-13T00:00:00-05:00" />
    
    <meta property="og:url" content="/2014/01/thread-scheduling-in-android.html" />
    <meta property="og:site_name" content="Android Design Patterns" />
    
    <meta property="og:image" content="/assets/images/favicon256.png" />
    <title>Thread Scheduling in Android | Android Design Patterns</title>
    <link rel="canonical" href="/2014/01/thread-scheduling-in-android.html" />
    <link rel="icon" href="/assets/images/favicon128.png" type="image/x-icon">
    <link href="/feed.atom" rel="alternate" title="Android Design Patterns - Feed" type="application/atom+xml" />
    <link rel="stylesheet" type="text/css" href="/css/all.css" />

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
  </head>

  <body>
    <div id="header">
      <div class="container">
        <h3 id="blog-header"><a href="/">Android Design Patterns</a></h3>
        <nav class="pull-right">
          <a href="/archives/">Archives</a>
          <a href="/about/">About</a>
        </nav>
      </div>
    </div>

    <div id="social" class="container">
      <a href="https://plus.google.com/100751609891157863386?rel=author" class="googleplus"><i class="icon-gplus"></i></a>
      <a href="https://twitter.com/alexjlockwood" class="twitter"><i class="icon-twitter"></i></a>
      <a href="https://github.com/alexjlockwood" class="github"><i class="icon-github-circled"></i></a>
      <a href="/feed.atom" class="rss"><i class="icon-rss"></i></a>
    </div>

    <div class="main container">
      <div id="content">
	<div class="blog-index">
          <div itemscope itemtype="http://schema.org/BlogPosting" class="post">
  <header><h1 itemprop="name">Thread Scheduling in Android</h1></header>

  <div class="side">
    <div class="date-posted" >
      Posted <span itemprop="datePublished" content="2014-01-13T00:00:00-05:00" class="date">Jan 13, 2014</span>
      <div class="author">by <a href="https://google.com/+AlexLockwood"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Alex Lockwood</span></span></a></div>
    </div>

    <div class="share-buttons">
      <div class="g-plusone" data-size="medium"></div>
      <div class="tweet"><a href="https://twitter.com/share" class="twitter-share-button" data-via="alexjlockwood" data-lang="en">Tweet</a></div>
      <div class="fb-like" data-href="/2014/01/thread-scheduling-in-android.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
    </div>
  </div>

  <div class="body">
    <div itemprop="articleBody">
      <p>This post will give an overview of how thread scheduling works in Android, and will briefly
demonstrate how to explicitly set
<a href="http://developer.android.com/reference/android/os/Process.html">thread priorities</a>
yourself to ensure that your application remains responsive even as multiple threads
run in the background.</p>

<p>For those who are unfamiliar with the term, a <em>thread scheduler</em> is the part of the operating system
in charge of deciding which threads in the system should run, when, and for how long. Android&#39;s thread
scheduler uses two main factors to determine how threads are scheduled across the entire
system: <em>nice values</em> and <em>cgroups</em>.</p>

<!--more-->

<h3>Nice values</h3>

<p>Similar to how they are used in Linux&#39;s completely fair scheduling policy, <em>nice values</em> in Android
are used as a measure of a thread&#39;s priority. Threads with a higher nice value (i.e., lower priority,
as in they are being &quot;nice&quot; to other threads in the system) will run less often than
those with lower nice values (i.e., higher priority). The two most important of these are the
<a href="http://developer.android.com/reference/android/os/Process.html#THREAD_PRIORITY_DEFAULT">default</a>
and <a href="http://developer.android.com/reference/android/os/Process.html#THREAD_PRIORITY_BACKGROUND">background</a>
thread priorities. Intuitively, thread priorities should be chosen
inverse-proportionally to the amount of work the thread is expected to do: the more work the
thread will do, the less favorable thread priority it should get so that it doesn&#39;t
starve the system. For this reason, user interface threads (such as the main thread of a foreground <code>Activity</code>) 
are typically given a default priority, whereas background threads (such as a thread executing an <code>AsyncTask</code>)
are typically given a background priority.</p>

<p>Nice values are theoretically important because they help reduce background work that might otherwise
interrupt the user interface. In practice, however, they alone are not sufficient. For example, consider
twenty background threads and a single foreground thread driving the UI. Despite their low
individual priorities, collectively the twenty background threads will still likely impact the performance
of the single foreground thread, resulting in lag and hurting the user experience. Since at any given moment
several applications could potentially have background threads waiting to run, the Android OS
must somehow address these scenarios. Enter <em>cgroups</em>.</p>

<h3>Cgroups</h3>

<p>To address this problem, Android enforces an even stricter foreground vs. background scheduling policy
using Linux <a href="http://en.wikipedia.org/wiki/Cgroups"><em>cgroups</em></a> (control groups). Threads with
background priorities are implicitly moved into a background cgroup, where they are
limited to only a small percentage<sup><a href="#footnote1" id="ref1">1</a></sup> of the available
CPU if threads in other groups are busy. This separation allows background threads to make some
forward progress, without having enough of an impact on the foreground threads to be visible
to the user.</p>

<p>In addition to automatically assigning low-priority threads to the background cgroup, Android ensures that all
threads belonging to applications not currently running in the foreground are implicitly moved to the background cgroup as well. This automatic assignment of application threads to cgroups ensures that the current foreground
application thread will always be the priority, regardless of how many applications are running in the background.</p>

<h3>Setting Priorities with <code>Process#setThreadPriority(int)</code></h3>

<p>For the most part, the Android APIs already assign worker threads a background priority for you
(for example, see the source code for
<a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/core/java/android/os/HandlerThread.java"><code>HandlerThread</code></a>
and <a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/core/java/android/os/AsyncTask.java"><code>AsyncTask</code></a>). It is important to remember, however, that this will not always be the case.
<code>Thread</code>s and <code>ExecutorService</code>s that are instantiated on the main UI thread, for example,
will inherit a default, foreground priority, making lag more likely and possibly hurting
the application&#39;s performance. In these cases, you should <em>always</em> remember to set the thread&#39;s
priority by calling
<a href="https://developer.android.com/reference/android/os/Process.html#setThreadPriority(int)"><code>Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND)</code></a>
before the <code>Thread</code> is run. Doing so is straightforward, as shown in the example below:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Process</span><span class="o">.</span><span class="na">setThreadPriority</span><span class="o">(</span><span class="n">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_BACKGROUND</span><span class="o">);</span>

    <span class="c1">// ...</span>
  <span class="o">}</span>
<span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</code></pre></div>
<p>As always, thanks for reading, and leave a comment if you have any questions. Don&#39;t forget to +1 this blog post too! </p>

<hr class="footnote-divider" />

<p><sup id="footnote1">1</sup> This percentage was 5% at the time of this writing, though it is possible that this value could change in the future. As of Android 4.4.2, cgroup mount points are created and initialized at boot-up in <a href="https://android.googlesource.com/platform/system/core/+/android-sdk-4.4.2_r1/rootdir/init.rc"><code>/system/core/rootdir/init.rc</code></a> (see lines 100-123). <a href="#ref1" title="Jump to footnote 1.">&#8617;</a></p>

    </div>
    
    <div class="post-pagination">
      
      <div class="prev"><a rel="prev" href="/2014/01/redesigning-android-design-patterns.html">Older &#187;</a></div>
      
      
    </div>

    <div id="responsive-post-bottom-ad">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-3588752900040136"
           data-ad-slot="6089694851"
           data-ad-format="auto"></ins>
      <script>
	(adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
    
    <div class="post-comments">
      <div id="disqus_thread"></div>
      <script src="/scripts/disqus-lazy-load.js"></script>
    </div>
    
  </div>

  
  <div class="side suggested">
    <h4>Related Posts</h4>
    <ul class="related">
    <li><a href="/2013/04/activitys-threads-memory-leaks.html">Activitys, Threads, &amp; Memory Leaks</a></li>
    <li><a href="/2012/10/sqlite-contentprovider-thread-safety.html">SQLite, Content Providers, &amp; Thread Safety</a></li>
    <li><a href="/2013/07/binders-window-tokens.html">Binders &amp; Window Tokens</a></li>
    </ul>
  </div>
  
</div>

	</div>
      </div>

      <div id="info" class="cf">
	<div class="right">
          <div class="box">
            <h3>+1 this blog!</h3>
            <p>Android Design Patterns is a website for developers who wish to better understand the Android application framework. The tutorials here emphasize proper code design and project maintainability.</p>
            <div style="text-align:center">
              <div class="g-plusone" data-href=""></div>
	      <div class="tweet"><a href="https://twitter.com/share" class="twitter-share-button" data-via="alexjlockwood" data-lang="en">Tweet</a></div>
	      <div class="fb-like" data-href="/2014/01/thread-scheduling-in-android.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
            </div>
          </div>
          <div class="box">
            <h3>Find a typo?</h3>
            <p>Submit a pull request! The code powering this site is open-source and available on <a href="https://github.com/alexjlockwood/alexjlockwood.github.io">GitHub</a>. Corrections are appreciated and encouraged! Click <a href="https://github.com/alexjlockwood/alexjlockwood.github.io/blob/master/README.md#find-a-typo">here</a> for instructions.</p>
          </div>
	</div>
	<div class="box gbadge">
          <div class="g-person" data-href="//plus.google.com/+AlexLockwood" data-rel="author"></div>
	</div>
      </div>
    </div>

    <div id="responsive-home-page-bottom-ad" class="container">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-3588752900040136"
           data-ad-slot="3555030858"
           data-ad-format="auto"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>

    <div id="copyright" class="container">
      <p>&copy; 2012-2014 Android Design Patterns</p>
    </div>

    <!-- +1 button javascript -->
    <script type="text/javascript">
      (function(){var a=document.createElement("script");
      a.type="text/javascript";a.async=true;a.src="https://apis.google.com/js/platform.js";
      var b=document.getElementsByTagName("script")[0];
      b.parentNode.insertBefore(a,b)})();
    </script>

    <!-- Tweet button javascript -->
    <script>!function(e,a,f){var c,b=e.getElementsByTagName(a)[0];if(!e.getElementById(f)){c=e.createElement(a);c.id=f;c.src="https://platform.twitter.com/widgets.js";b.parentNode.insertBefore(c,b)}}(document,"script","twitter-wjs");</script>

    <!-- Like button javascript -->
    <div id="fb-root"></div><script>(function(e,a,f){var c,b=e.getElementsByTagName(a)[0];if(e.getElementById(f)){return}c=e.createElement(a);c.id=f;c.src="//connect.facebook.net/en_US/all.js#xfbml=1";b.parentNode.insertBefore(c,b)}(document,"script","facebook-jssdk"));</script>

  </body>
</html>
