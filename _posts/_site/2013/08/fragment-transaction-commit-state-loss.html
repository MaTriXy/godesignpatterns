<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-site-verification" content="VqGny1x9EAeoXjY8v2hWFZGBUZFNQnavIOXVkY50mdk" />
    <meta name="msvalidate.01" content="AFECEF07C08280E3BFA946DDCE26B76C" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@alexjlockwood" />
    <meta name="twitter:creator" content="@alexjlockwood" />
    <meta name="twitter:domain" content="" />
    
    <!-- Don't include normal description meta tag for now. Only include twitter:description since it is explicitly required. -->
    <meta name="twitter:description" content="Android Design Patterns is a website for developers who wish to better understand the Android application framework. The tutorials here emphasize proper code design and project maintainability." />
    
    <meta property="og:locale" content="en_US" />
    <meta property="og:title" content="Fragment Transactions &amp; Activity State Loss" />
    
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2013-08-20T00:00:00-04:00" />
    <meta property="article:modified_time" content="2014-01-08T00:00:00-05:00" />
    
    <meta property="og:url" content="/2013/08/fragment-transaction-commit-state-loss.html" />
    <meta property="og:site_name" content="Android Design Patterns" />
    
    <meta property="og:image" content="/assets/images/favicon.jpg" />
    <title>Fragment Transactions &amp; Activity State Loss | Android Design Patterns</title>
    <link rel="canonical" href="/2013/08/fragment-transaction-commit-state-loss.html" />
    <link rel="icon" href="/assets/images/favicon.jpg" type="image/x-icon">
    <link href="/feed.atom" rel="alternate" title="Android Design Patterns - Feed" type="application/atom+xml" />
    <link rel="stylesheet" type="text/css" href="/css/all.css" />

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
  </head>

  <body>
    <div id="header">
      <div class="container">
        <h3 id="blog-header"><a href="/">Android Design Patterns</a></h3>
        <nav class="pull-right">
          <a href="/archives/">Archives</a>
          <a href="/about/">About</a>
        </nav>
      </div>
    </div>

    <div id="social" class="container">
      <a href="https://plus.google.com/100751609891157863386?rel=author" class="googleplus"><i class="icon-gplus"></i></a>
      <a href="https://twitter.com/alexjlockwood" class="twitter"><i class="icon-twitter"></i></a>
      <a href="https://github.com/alexjlockwood" class="github"><i class="icon-github-circled"></i></a>
      <a href="/feed.atom" class="rss"><i class="icon-rss"></i></a>
    </div>

    <div class="main container">
      <div id="content">
	<div class="blog-index">
          <div itemscope itemtype="http://schema.org/BlogPosting" class="post">
  <header><h1 itemprop="name">Fragment Transactions &amp; Activity State Loss</h1></header>

  <div class="side">
    <div class="date-posted" >
      Posted <span itemprop="datePublished" content="2013-08-20T00:00:00-04:00" class="date">Aug 20, 2013</span>
      <div class="author">by <a href="https://google.com/+AlexLockwood"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Alex Lockwood</span></span></a></div>
    </div>

    <div class="share-buttons">
      <div class="g-plusone" data-size="medium"></div>
      <div class="tweet"><a href="https://twitter.com/share" class="twitter-share-button" data-via="alexjlockwood" data-lang="en">Tweet</a></div>
      <div class="fb-like" data-href="/2013/08/fragment-transaction-commit-state-loss.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
    </div>
  </div>

  <div class="body">
    <div itemprop="articleBody">
      <p>The following stack trace and exception message has plagued StackOverflow
ever since Honeycomb&#39;s initial release:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">java.lang.IllegalStateException: Can not perform this action after onSaveInstanceState
    at android.support.v4.app.FragmentManagerImpl.checkStateLoss(FragmentManager.java:1341)
    at android.support.v4.app.FragmentManagerImpl.enqueueAction(FragmentManager.java:1352)
    at android.support.v4.app.BackStackRecord.commitInternal(BackStackRecord.java:595)
    at android.support.v4.app.BackStackRecord.commit(BackStackRecord.java:574)
</code></pre></div>
<p>This post will explain <em>why</em> and <em>when</em> this exception is thrown, and will
conclude with several suggestions that will help ensure it never crashes your
application again.</p>

<!--more-->

<h3>Why was the exception thrown?</h3>

<p>The exception was thrown because you attempted to commit a <code>FragmentTransaction</code>
after the activity&#39;s state had been saved, resulting in a phenomenon known as <em>Activity
state loss</em>. Before we get into the details of what this actually means, however, let&#39;s
first take a look at what happens under-the-hood when <code>onSaveInstanceState()</code> is
called. As I discussed in my last post about
<a href="/2013/08/binders-death-recipients.html">Binders
&amp; Death Recipients</a>, Android applications have very little control over their destiny
within the Android runtime environment. The Android system has the power to terminate processes
at any time to free up memory, and background activities may be killed with little to no warning
as a result. To ensure that this sometimes erratic behavior remains hidden from the user, the
framework gives each Activity a chance to save its state by calling its <code>onSaveInstanceState()</code>
method before making the Activity vulnerable to destruction. When the saved state is later
restored, the user will be given the perception that they are seamlessly switching between
foreground and background activities, regardless of whether or not the Activity had been
killed by the system.</p>

<p>When the framework calls <code>onSaveInstanceState()</code>, it passes the method a
<code>Bundle</code> object for the Activity to use to save its state, and the Activity
records in it the state of its dialogs, fragments, and views. When the method returns,
the system parcels the <code>Bundle</code> object across a Binder interface to the
System Server process, where it is safely stored away. When the system later decides
to recreate the Activity, it sends this same <code>Bundle</code> object back to the
application, for it to use to restore the Activity&#39;s old state.</p>

<p>So why then is the exception thrown? Well, the problem stems from the fact that
these <code>Bundle</code> objects represent a snapshot of an Activity at the moment
<code>onSaveInstanceState()</code> was called, and nothing more. That means when you call
<code>FragmentTransaction#commit()</code> after <code>onSaveInstanceState()</code> is
called, the transaction won&#39;t be remembered because it was never recorded as part of the
Activity&#39;s state in the first place. From the user&#39;s point of view, the transaction will
appear to be lost, resulting in accidental UI state loss. In order to protect the user
experience, Android avoids state loss at all costs, and simply throws an
<code>IllegalStateException</code> whenever it occurs.</p>

<h3>When is the exception thrown?</h3>

<p>If you&#39;ve encountered this exception before, you&#39;ve probably noticed that the moment
when it is thrown is slightly inconsistent across different platform versions. For
example, you probably found that older devices tended to throw the exception less
frequently, or that your application was more likely to crash when using the support
library than when using the official framework classes. These slight inconsistencies
have led many to assume that the support library is buggy and can&#39;t be trusted.
These assumptions, however, are generally not true.</p>

<p>The reason why these slight inconsistencies exist stems from a significant change to
the Activity lifecycle that was made in Honeycomb. Prior to Honeycomb, activities
were not considered killable until after they had been paused, meaning that
<code>onSaveInstanceState()</code> was called immediately before <code>onPause()</code>.
Beginning with Honeycomb, however, Activities are considered to be killable only
after they have been <em>stopped</em>, meaning that <code>onSaveInstanceState()</code>
will now be called before <code>onStop()</code> instead of immediately before
<code>onPause()</code>. These differences are summarized in the table below:</p>

<table><thead>
<tr>
<th></th>
<th>pre-Honeycomb</th>
<th>post-Honeycomb</th>
</tr>
</thead><tbody>
<tr>
<td>Activities can be killed before <code>onPause()</code>?</td>
<td>NO</td>
<td>NO</td>
</tr>
<tr>
<td>Activities can be killed before <code>onStop()</code>?</td>
<td>YES</td>
<td>NO</td>
</tr>
<tr>
<td><code>onSaveInstanceState(Bundle)</code> is guaranteed to be called before...</td>
<td><code>onPause()</code></td>
<td><code>onStop()</code></td>
</tr>
</tbody></table>

<p>As a result of the slight changes that were made to the Activity lifecycle, the support
library sometimes needs to alter its behavior depending on the platform version. For
example, on Honeycomb devices and above, an exception will be thrown each and every
time a <code>commit()</code> is called after <code>onSaveInstanceState()</code>
to warn the developer that state loss has occurred. However, throwing an exception
every time this happened would be too restrictive on pre-Honeycomb devices, which
have their <code>onSaveInstanceState()</code> method called much earlier in the
Activity lifecycle and are more vulnerable to accidental state loss as a result.
The Android team was forced to make a compromise: for better inter-operation with
older versions of the platform, older devices would have to live with the accidental
state loss that might result between <code>onPause()</code> and <code>onStop()</code>.
The support library&#39;s behavior across the two platforms is summarized in the table below:</p>

<table><thead>
<tr>
<th></th>
<th>pre-Honeycomb</th>
<th>post-Honeycomb</th>
</tr>
</thead><tbody>
<tr>
<td><code>commit()</code> before <code>onPause()</code></td>
<td>OK</td>
<td>OK</td>
</tr>
<tr>
<td><code>commit()</code> between <code>onPause()</code> and <code>onStop()</code></td>
<td>STATE LOSS</td>
<td>OK</td>
</tr>
<tr>
<td><code>commit()</code> after <code>onStop()</code></td>
<td>EXCEPTION</td>
<td>EXCEPTION</td>
</tr>
</tbody></table>

<h3>How to avoid the exception?</h3>

<p>Avoiding Activity state loss becomes a whole lot easier once you understand what is actually
going on. If you&#39;ve made it this far in the post, hopefully you understand a little better
how the support library works and why it is so important to avoid state loss in your applications.
In case you&#39;ve referred to this post in search of a quick fix, however, here are some suggestions
to keep in the back of your mind as you work with <code>FragmentTransaction</code>s in your applications:</p>

<ul>
<li><p><strong>Be careful when committing transactions inside Activity lifecycle methods.</strong> 
A large majority of applications will only ever commit transactions the very first
time <code>onCreate()</code> is called and/or in response to user input, and will
never face any problems as a result. However, as your transactions begin to venture
out into the other Activity lifecycle methods, such as <code>onActivityResult()</code>,
<code>onStart()</code>, and <code>onResume()</code>, things can get a little tricky.
For example, you should not commit transactions inside the <code>FragmentActivity#onResume()</code>
method, as there are some cases in which the method can be called before the
activity&#39;s state has been restored (see the
<a href="http://developer.android.com/reference/android/support/v4/app/FragmentActivity.html#onResume()">documentation</a>
for more information). If your application requires committing a transaction in
an Activity lifecycle method other than <code>onCreate()</code>, do it in either
<code>FragmentActivity#onResumeFragments()</code> or <code>Activity#onPostResume()</code>.
These two methods are guaranteed to be called after the Activity has been restored to its
original state, and therefore avoid the possibility of state loss all together.
(As an example of how this can be done, check out my answer to
<a href="http://stackoverflow.com/q/16265733/844882">this StackOverflow question</a> for
some ideas on how to commit <code>FragmentTransaction</code>s in response to calls
made to the <code>Activity#onActivityResult()</code> method).</p></li>
<li><p><strong>Avoid performing transactions inside asynchronous callback methods.</strong> This
includes commonly used methods such as <code>AsyncTask#onPostExecute()</code> and
<code>LoaderManager.LoaderCallbacks#onLoadFinished()</code>. The problem with
performing transactions in these methods is that they have no knowledge of the
current state of the Activity lifecycle when they are called. For example,
consider the following sequence of events:</p>

<ol>
<li>An activity executes an <code>AsyncTask</code>.</li>
<li>The user presses the &quot;Home&quot; key, causing the activity&#39;s <code>onSaveInstanceState()</code>
 and <code>onStop()</code> methods to be called.</li>
<li>The <code>AsyncTask</code> completes and <code>onPostExecute()</code> is called, unaware that the
 Activity has since been stopped.</li>
<li>A <code>FragmentTransaction</code> is committed inside the <code>onPostExecute()</code> method, causing
 an exception to be thrown.</li>
</ol>

<p>In general, the best way to avoid the exception in these cases is to simply avoid
committing transactions in asynchronous callback methods all together. Google
engineers seem to agree with this belief as well. According to
<a href="https://groups.google.com/d/msg/android-developers/dXZZjhRjkMk/QybqCW5ukDwJ">this post</a>
on the Android Developers group, the Android team considers the major shifts in UI
that can result from committing <code>FragmentTransaction</code>s from within
asynchronous callback methods to be bad for the user experience. If your application
requires performing the transaction inside these callback methods and there is no
easy way to guarantee that the callback won&#39;t be invoked after <code>onSaveInstanceState()</code>,
you may have to resort to using <code>commitAllowingStateLoss()</code> and
dealing with the state loss that might occur. (See also these two StackOverflow
posts for additional hints, <a href="http://stackoverflow.com/q/8040280/844882">here</a>
and <a href="http://stackoverflow.com/q/7992496/844882">here</a>).</p></li>
<li><p><strong>Use <code>commitAllowingStateLoss()</code> only as a last resort.</strong> The only
difference between calling <code>commit()</code> and <code>commitAllowingStateLoss()</code>
is that the latter will not throw an exception if state loss occurs. Usually you don&#39;t
want to use this method because it implies that there is a possibility that state loss
could happen. The better solution, of course, is to write your application so that
<code>commit()</code> is guaranteed to be called before the activity&#39;s state has been
saved, as this will result in a better user experience. Unless the possibility of
state loss can&#39;t be avoided, <code>commitAllowingStateLoss()</code> should not be used.</p></li>
</ul>

<p>Hopefully these tips will help you resolve any issues you have had with this exception
in the past. If you are still having trouble, post a question on
<a href="http://stackoverflow.com">StackOverflow</a> and post a link in a comment below
and I can take a look. :)</p>

<p>As always, thanks for reading, and leave a comment if you have any questions.
Don&#39;t forget to +1 this blog and share this post on Google+ if you found it interesting!</p>

    </div>
    
    <div id="post-last-updated">Last updated January 8, 2014.</div>
    
    <div class="post-pagination">
      
      <div class="prev"><a rel="prev" href="/2013/08/binders-death-recipients.html">Older &#187;</a></div>
      
      
      <div class="next"><a rel="next" href="/2014/01/redesigning-android-design-patterns.html">&#171; Newer</a></div>
      
    </div>

    <div id="responsive-post-bottom-ad">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-3588752900040136"
           data-ad-slot="6089694851"
           data-ad-format="auto"></ins>
      <script>
	(adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
    
    <div class="post-comments">
      <div id="disqus_thread"></div>
      <script src="/scripts/disqus-lazy-load.js"></script>
    </div>
    
  </div>

  
  <div class="side suggested">
    <h4>Related Posts</h4>
    <ul class="related">
    <li><a href="/2013/04/retaining-objects-across-config-changes.html">Handling Configuration Changes with Fragments</a></li>
    <li><a href="/2012/08/implementing-loaders.html">Implementing Loaders (part 3)</a></li>
    <li><a href="/2012/10/sqlite-contentprovider-thread-safety.html">SQLite, Content Providers, &amp; Thread Safety</a></li>
    </ul>
  </div>
  
</div>

<!-- Tweet button javascript -->
<script>!function(e,a,f){var c,b=e.getElementsByTagName(a)[0];if(!e.getElementById(f)){c=e.createElement(a);c.id=f;c.src="https://platform.twitter.com/widgets.js";b.parentNode.insertBefore(c,b)}}(document,"script","twitter-wjs");</script>

<!-- Like button javascript -->
<div id="fb-root"></div><script>(function(e,a,f){var c,b=e.getElementsByTagName(a)[0];if(e.getElementById(f)){return}c=e.createElement(a);c.id=f;c.src="//connect.facebook.net/en_US/all.js#xfbml=1";b.parentNode.insertBefore(c,b)}(document,"script","facebook-jssdk"));</script>

	</div>
      </div>

      <div id="info" class="cf">
	<div class="right">
          <div class="box">
            <h3>About this Blog</h3>
            <p>Android Design Patterns is a website for developers who wish to better understand the Android application framework. The tutorials here emphasize proper code design and project maintainability.</p>
            <div class="g-plusone" data-annotation="inline" data-width="300" data-href=""></div>
          </div>
          <div class="box">
            <h3>Find a typo?</h3>
            <p>Submit a pull request! The code powering this site is open-source and available on <a href="https://github.com/alexjlockwood/alexjlockwood.github.io">GitHub</a>. Corrections are appreciated and encouraged! Click <a href="https://github.com/alexjlockwood/alexjlockwood.github.io/blob/master/README.md#find-a-typo">here</a> for instructions.</p>
          </div>
	</div>
	<div class="box gbadge">
          <div class="g-person" data-href="//plus.google.com/+AlexLockwood" data-rel="author"></div>
	</div>
      </div>
    </div>

    <div id="responsive-home-page-bottom-ad" class="container">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-3588752900040136"
           data-ad-slot="3555030858"
           data-ad-format="auto"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>

    <div id="copyright" class="container">
      <p>&copy; 2012-2014 Android Design Patterns</p>
    </div>

    <script type="text/javascript">
      (function(){var a=document.createElement("script");
      a.type="text/javascript";a.async=true;a.src="https://apis.google.com/js/platform.js";
      var b=document.getElementsByTagName("script")[0];
      b.parentNode.insertBefore(a,b)})();
    </script>

  </body>
</html>
